<!DOCTYPE html>
<html lang="en" style="height: 98%">
<head>
    <meta charset="UTF-8">
    <title>OneDay</title>
    <style>
        h1, h2 {text-align: center; color: #78aeed}
        table {height: 60%; border: lightgrey; margin: auto}
        body {background: #242424; font-family: Calibri; font-size: 2.2vh}
        th {color: aquamarine; background: #363636; padding: 8px}
        td {color: white; background: #363636; padding: 15px; max-width: 33vh;}
        button {display: inline-block; border: 0; background: #363636; color: white; height: 15vh; width: 14vh; font-size: 2.6vh;}
        button:hover{ background: #3e3e3e }
        .timeBar{
            height: 0%;
            width: 100%;
            background-color: #496ee8;
        }

        .thTimeBar{
            padding: 0;
        }
    </style>
</head>
    <body style="
    display: flex;
    flex-direction: column;
    height: 100%;
    ">
    <div style="
    flex: 1 0 auto;
    ">
        <div>
            <h1 id="day">Today</h1>
        </div>
        <div>
            <h2 id="week">of the week</h2>
        </div>

        
    <table id="allday" style="justify-content: center; margin: auto">
        <tr>
            <th style="background-color: #242424"></th>
            <th style="border-top-left-radius: 15px" id="time">Time</th>
            <th style="border-top-right-radius: 15px" id="lesson">Lessons</th>
        </tr>
    </table>
    
    </div>
    <div style="text-align: center; flex: 0 0 auto">
        <button id="yesterday" style="display: inline-block; justify-content: left; border-bottom-left-radius: 25px; border-top-left-radius: 25px">
            <
        </button>
        <button onclick="location.href ='./' ">Menu</button>
        <button id="tomorrow" style="display: inline-block; border-top-right-radius: 25px; border-bottom-right-radius: 25px">
            >
        </button>
    </div>
    <script>
            let dates = [];
        
            document.getElementById("tomorrow").addEventListener("click", () => {
               const params = getQueryParams(location.href);
               const dayOffset = params['day'];
               location.href = `today?day=${Number(dayOffset) + 1}`;
            });
            
            document.getElementById("yesterday").addEventListener("click", () => {
                const params = getQueryParams(location.href);
                const dayOffset = params['day'];
                location.href = `today?day=${Number(dayOffset) - 1}`;
            })
            
            const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
            
            async function GetDay(){
                const params = getQueryParams(location.href);
                const dayOffset = params['day'];
                
                const response = await fetch(`/today/api/${dayOffset}`, {
                    method: "GET",
                    headers: {"Accept" : "application/json"}
                });
                
                if (response.ok === true){
                    const day = await response.json();
                    SetDay(day);
                    setInterval(startCheckProgress, 100);
                }
            }
            function getQueryParams(url) {
                const paramArr = url.slice(url.indexOf('?') + 1).split('&');
                const params = {};
                paramArr.map(param => {
                    const [key, val] = param.split('=');
                    params[key] = decodeURIComponent(val);
                })
                return params;
            }
            
            function SetDay(day){
                if (day.weekday === -1) {
                    document.getElementById("day").innerText = "Sunday"
                }
                else{
                    document.getElementById("day").innerText = days[day.weekday - 1];
                }
                let week;
                switch (day.week){
                    case 1:
                        week = "of the first week."
                        break;
                    case 2:
                        week = "of the second week."
                        break;
                }
                document.getElementById("week").innerText = week;
                if (day.weekday === -1 || day.subjects.length === 0){
                    document.getElementById("allday").remove();
                }else{
                    day.subjects.forEach( _ => SetLesson(_))
                }
            }
            let td = document.getElementById("lesson");
            let counter = 0;
            let progressBar;
            let progressDiv;
            
            function SetLesson(lesson){
                td.style.borderBottomRightRadius = ""
                const table = document.getElementById("allday");
                const tr = document.createElement("tr");
                const th = document.createElement("th");
                td = document.createElement("td");
                td.style.borderBottomRightRadius = "15px"
                
                const time = (lesson.time.start + ":" + lesson.time.end).split(":");
                
                th.innerText = time[0] + ":" + time[1] + "-\n" + time[3] + ":" + time[4];
                
                let content = lesson.name + "[" + lesson.type + "]\n";
                lesson.audience.forEach(a => content += a.name + "\n");
                lesson.teachers.forEach(t => content += t.name + "\n");
                console.log(content);
                td.innerText = content;

                switch (lesson.type){
                    case "лаб.":
                        td.style.backgroundColor = "#526D73";
                        break;
                    case "пр.з.":
                        td.style.backgroundColor = "#735252";
                        break;
                    case "лк.":
                        td.style.backgroundColor = "#657352";
                        break;
                }
                
                if (counter !== 0){
                    progressBar.style.borderBottomLeftRadius = "";
                    progressDiv.style.borderBottomLeftRadius = "";
                }
                
                progressBar = document.createElement("th");
                progressBar.style.borderBottomLeftRadius = "15px";
                progressBar.className = "thTimeBar";
                
                
                progressDiv = document.createElement("div");
                progressDiv.id = lesson.time.start;
                progressDiv.style.borderBottomLeftRadius = "15px";
                progressDiv.setAttribute("class", "timeBar")
                progressBar.append(progressDiv);
                tr.append(progressBar);
                tr.append(th);
                tr.appendChild(td);
                table.append(tr);
                if (counter === 0){
                    progressBar.style.borderTopLeftRadius = "15px";
                    progressDiv.style.borderTopLeftRadius = "15px";
                }
                
                const startPoint = new Date();
                startPoint.setHours(Number(time[0]), Number(time[1]));
                startPoint.setTime(startPoint.getTime() + (Number(getQueryParams(location.href)['day']) * 24 * 60 * 60 * 1000));
                const endPoint = new Date();
                endPoint.setHours(Number(time[3]), Number(time[4]));
                endPoint.setTime(endPoint.getTime() + (Number(getQueryParams(location.href)['day']) * 24 * 60 * 60 * 1000));
                
                
                let m = [startPoint, endPoint, progressDiv.id];
                dates.push(m);
                
                counter++;
            }
            
            function startCheckProgress(){
                for (const date of dates) {
                    checkProgress(date);
                }
            }
            
            function checkProgress(date){
                const currentPoint = new Date();
                const startPoint = date[0];
                const endPoint = date[1];
                const progressBar = document.getElementById(date[2]);
                
                const final = endPoint.getTime() - startPoint.getTime();
                let progress = 0;
                if (currentPoint.getTime() < endPoint.getTime()){
                    progress = (currentPoint.getTime() - startPoint.getTime()) * 100 / final;
                }
                else{
                    progress = 100;
                }
                progressBar.style.height = `${progress}%`;
            }
            GetDay();

        </script>
    </body>
</html>