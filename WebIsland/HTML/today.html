<!DOCTYPE html>
<html lang="en" style="height: 98%">
<head>
    <meta charset="UTF-8">
    <title>OneDay</title>
    <style>
        h1, h2 {text-align: center; color: #78aeed}
        table {height: 60%; border: lightgrey; margin: auto}
        body {background: #242424; font-family: Calibri; font-size: 2.2vh}
        th {color: aquamarine; background: #363636; padding: 8px}
        td {color: white; background: #363636; padding: 15px; max-width: 33vh;}
        button {display: inline-block; border: 0; background: #363636; color: white; height: 15vh; width: 14vh; font-size: 2.6vh;}
        button:hover{ background: #3e3e3e }
    </style>
</head>
    <body style="
    display: flex;
    flex-direction: column;
    height: 100%;
    ">
    <div style="
    flex: 1 0 auto;
    ">
        <div>
            <h1 id="day">Today is undefined</h1>
        </div>
        <div>
            <h2 id="week">of the week</h2>
        </div>

        
    <table id="allday" style="justify-content: center; margin: auto">
        <tr>
            <th style="border-top-left-radius: 15px" id="time">Time</th>
            <th style="border-top-right-radius: 15px" id="lesson">Lessons</th>
        </tr>
    </table>
    
    </div>
    <div style="text-align: center; flex: 0 0 auto">
        <button id="yesterday" style="display: inline-block; justify-content: left; border-bottom-left-radius: 25px; border-top-left-radius: 25px">
            <
        </button>
        <button onclick="location.href ='./' ">Menu</button>
        <button id="tomorrow" style="display: inline-block; border-top-right-radius: 25px; border-bottom-right-radius: 25px">
            >
        </button>
    </div>
    <script>
            document.getElementById("tomorrow").addEventListener("click", () => {
               const params = getQueryParams(location.href);
               const dayOffset = params['day'];
               location.href = `today?day=${Number(dayOffset) + 1}`;
            });
            
            document.getElementById("yesterday").addEventListener("click", () => {
                const params = getQueryParams(location.href);
                const dayOffset = params['day'];
                location.href = `today?day=${Number(dayOffset) - 1}`;
            })
            
            const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
            
            async function GetDay(){
                const params = getQueryParams(location.href);
                const dayOffset = params['day'];
                
                const response = await fetch(`/today/api/${dayOffset}`, {
                    method: "GET",
                    headers: {"Accept" : "application/json"}
                });
                
                if (response.ok === true){
                    const day = await response.json();
                    SetDay(day);
                }
            }
            function getQueryParams(url) {
                const paramArr = url.slice(url.indexOf('?') + 1).split('&');
                const params = {};
                paramArr.map(param => {
                    const [key, val] = param.split('=');
                    params[key] = decodeURIComponent(val);
                })
                return params;
            }
            
            function SetDay(day){
                if (day.weekday === -1) {
                    document.getElementById("day").innerText = "Today is Sunday"
                }
                else{
                    document.getElementById("day").innerText = "Today is " + days[day.weekday - 1];
                }
                let week;
                switch (day.week){
                    case 1:
                        week = "of the first week."
                        break;
                    case 2:
                        week = "of the second week."
                        break;
                }
                document.getElementById("week").innerText = week;
                if (day.weekday === -1 || day.subjects.length === 0){
                    document.getElementById("allday").remove();
                }else{
                    day.subjects.forEach( _ => SetLesson(_))
                }
            }
            let td = document.getElementById("lesson");
            let th = document.getElementById("time");
            function SetLesson(lesson){
                td.style.borderBottomRightRadius = ""
                th.style.borderBottomLeftRadius = ""
                const table = document.getElementById("allday");
                const tr = document.createElement("tr");
                th = document.createElement("th");
                td = document.createElement("td");
                td.style.borderBottomRightRadius = "15px"
                th.style.borderBottomLeftRadius = "15px"
                
                const time = (lesson.time.start + ":" + lesson.time.end).split(":");
                
                th.innerText = time[0] + ":" + time[1] + "-\n" + time[3] + ":" + time[4];
                
                let content = lesson.name + "[" + lesson.type + "]\n";
                lesson.audience.forEach(a => content += a.name + "\n");
                lesson.teachers.forEach(t => content += t.name + "\n");
                console.log(content);
                td.innerText = content;

                switch (lesson.type){
                    case "лаб.":
                        td.style.backgroundColor = "#526D73";
                        break;
                    case "пр.з.":
                        td.style.backgroundColor = "#735252";
                        break;
                    case "лк.":
                        td.style.backgroundColor = "#657352";
                        break;
                }
                tr.append(th);
                tr.appendChild(td);
                table.append(tr);
            }
            GetDay();

        </script>
    </body>
</html>